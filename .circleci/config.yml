version: 2

jobs:
  deploy_image:
     working_directory: ~/build
     docker:
       - image: docker:17.05.0-ce-git
     steps:
       - checkout
       - setup_remote_docker
       - run:
           name: Build docker image
           command: |
             docker build -t build/cui-browser -f ./devops/Dockerfile ./
             docker login -u $DOCKER_USER -p $DOCKER_PASS
       - deploy:
           name: Upload :latest image to DockerHub
           command: |
             docker tag build/cui-browser cybernode/cui-browser:latest
             docker push cybernode/cui-browser:latest
             if [[ "$CIRCLE_TAG" != "" ]]; then
                # $CIRCLE_TAG is only set when building tags
                docker tag build/cui-browser cybernode/cui-browser:$CIRCLE_TAG
                docker push cybernode/cui-browser:$CIRCLE_TAG
             fi

workflows:
  version: 2

  ui_build_deploy:
    jobs:
      - deploy_image:
          filters:
            # build and deploy for all tags AND commits in master
            tags:
              only: /.*/
            branches:
              only: master
